<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´å­—æ®µä¿®æ”¹åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">å®Œæ•´å­—æ®µä¿®æ”¹åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- åˆ›å»ºæµ‹è¯•é“¾æ¥ -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">1. åˆ›å»ºåŒ…å«æ‰€æœ‰å­—æ®µçš„æµ‹è¯•é“¾æ¥</h2>
            <button id="createTestLink" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                åˆ›å»ºæµ‹è¯•é“¾æ¥
            </button>
            <div id="createResult" class="mt-4"></div>
        </div>

        <!-- æµ‹è¯•ä¿®æ”¹åŠŸèƒ½ -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4">2. æµ‹è¯•åå°ä¿®æ”¹åŠŸèƒ½</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">çŸ­é“¾æ¥Key:</label>
                    <input type="text" id="testShortKey" placeholder="è¾“å…¥è¦æµ‹è¯•çš„çŸ­é“¾æ¥key" 
                           class="w-full px-3 py-2 border rounded">
                </div>
                <button id="testEdit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æµ‹è¯•ä¿®æ”¹åŠŸèƒ½
                </button>
            </div>
            <div id="editResult" class="mt-4"></div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">3. æµ‹è¯•ç»“æœ</h2>
            <div id="testResults" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // åˆ›å»ºæµ‹è¯•é“¾æ¥
        document.getElementById('createTestLink').addEventListener('click', async () => {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = '<div class="text-blue-600">åˆ›å»ºä¸­...</div>';

            try {
                const testData = {
                    longUrl: 'https://www.example.com/test-page',
                    shortKey: 'test-' + Date.now(),
                    title: 'æµ‹è¯•é“¾æ¥æ ‡é¢˜',
                    maxVisits: 100,
                    expiryDays: 30,
                    password: 'test123',
                    accessMode: 'proxy',
                    customHeaders: {
                        'subscription-userinfo': 'upload=0; download=1073741824; total=429496729600; expire=1735689600',
                        'content-disposition': 'attachment; filename*=UTF-8\'\'config.yaml'
                    }
                };

                const response = await axios.post('/api/links', testData);
                
                if (response.data.success) {
                    const link = response.data.data;
                    document.getElementById('testShortKey').value = link.shortKey;
                    resultDiv.innerHTML = `
                        <div class="text-green-600">
                            <p>âœ… æµ‹è¯•é“¾æ¥åˆ›å»ºæˆåŠŸï¼</p>
                            <p>çŸ­é“¾æ¥: <a href="/${link.shortKey}" target="_blank" class="text-blue-600 underline">${link.shortKey}</a></p>
                            <p>åŒ…å«å­—æ®µ: æ ‡é¢˜ã€è®¿é—®é™åˆ¶ã€å¯†ç ã€è‡ªå®šä¹‰å“åº”å¤´ç­‰</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="text-red-600">âŒ åˆ›å»ºå¤±è´¥: ${response.data.error.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        });

        // æµ‹è¯•ä¿®æ”¹åŠŸèƒ½
        document.getElementById('testEdit').addEventListener('click', async () => {
            const shortKey = document.getElementById('testShortKey').value;
            const resultDiv = document.getElementById('editResult');
            const testResultsDiv = document.getElementById('testResults');
            
            if (!shortKey) {
                alert('è¯·è¾“å…¥çŸ­é“¾æ¥key');
                return;
            }

            resultDiv.innerHTML = '<div class="text-blue-600">æµ‹è¯•ä¸­...</div>';
            testResultsDiv.innerHTML = '';

            try {
                // 1. è·å–åŸå§‹æ•°æ®
                const getResponse = await axios.get(`/api/links/${shortKey}`);
                if (!getResponse.data.success) {
                    throw new Error('è·å–é“¾æ¥å¤±è´¥: ' + getResponse.data.error.message);
                }

                const originalData = getResponse.data.data;
                addTestResult('âœ… è·å–åŸå§‹æ•°æ®æˆåŠŸ', 'text-green-600');

                // 2. æµ‹è¯•ä¿®æ”¹æ‰€æœ‰å­—æ®µ
                const updateData = {
                    longUrl: 'https://www.updated-example.com/new-page',
                    shortKey: shortKey + '-updated',
                    title: 'æ›´æ–°åçš„æ ‡é¢˜',
                    description: 'æ›´æ–°åçš„æè¿°',
                    maxVisits: 200,
                    currentVisits: 5,
                    expiryDays: 60,
                    password: 'newpass123',
                    accessMode: 'redirect',
                    isActive: true,
                    tags: ['æµ‹è¯•', 'æ›´æ–°', 'å®Œæ•´åŠŸèƒ½'],
                    subscriptionInfo: {
                        upload: '2',
                        download: '5',
                        total: '500',
                        expire: '2025-12-31'
                    },
                    contentDisposition: {
                        type: 'attachment',
                        filename: 'updated-config.yaml'
                    },
                    customHeaders: {
                        'x-custom-header': 'test-value',
                        'x-updated': 'true'
                    }
                };

                const updateResponse = await axios.put(`/api/links/${shortKey}`, updateData);
                
                if (updateResponse.data.success) {
                    addTestResult('âœ… æ‰€æœ‰å­—æ®µä¿®æ”¹æˆåŠŸ', 'text-green-600');
                    
                    // 3. éªŒè¯ä¿®æ”¹ç»“æœ
                    const verifyResponse = await axios.get(`/api/links/${updateData.shortKey}`);
                    if (verifyResponse.data.success) {
                        const updatedData = verifyResponse.data.data;
                        
                        // éªŒè¯å„ä¸ªå­—æ®µ
                        const checks = [
                            { field: 'longUrl', expected: updateData.longUrl, actual: updatedData.longUrl },
                            { field: 'shortKey', expected: updateData.shortKey, actual: updatedData.shortKey },
                            { field: 'title', expected: updateData.title, actual: updatedData.title },
                            { field: 'description', expected: updateData.description, actual: updatedData.description },
                            { field: 'maxVisits', expected: updateData.maxVisits, actual: updatedData.maxVisits },
                            { field: 'currentVisits', expected: updateData.currentVisits, actual: updatedData.currentVisits },
                            { field: 'accessMode', expected: updateData.accessMode, actual: updatedData.accessMode },
                            { field: 'isActive', expected: updateData.isActive, actual: updatedData.isActive }
                        ];

                        let allPassed = true;
                        checks.forEach(check => {
                            if (check.actual === check.expected) {
                                addTestResult(`âœ… ${check.field}: ${check.actual}`, 'text-green-600');
                            } else {
                                addTestResult(`âŒ ${check.field}: æœŸæœ› ${check.expected}, å®é™… ${check.actual}`, 'text-red-600');
                                allPassed = false;
                            }
                        });

                        // æ£€æŸ¥è‡ªå®šä¹‰å“åº”å¤´
                        if (updatedData.customHeaders) {
                            addTestResult('âœ… è‡ªå®šä¹‰å“åº”å¤´å·²ä¿å­˜', 'text-green-600');
                        } else {
                            addTestResult('âŒ è‡ªå®šä¹‰å“åº”å¤´æœªä¿å­˜', 'text-red-600');
                            allPassed = false;
                        }

                        if (allPassed) {
                            resultDiv.innerHTML = '<div class="text-green-600 font-semibold">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å®Œæ•´å­—æ®µä¿®æ”¹åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚</div>';
                        } else {
                            resultDiv.innerHTML = '<div class="text-yellow-600 font-semibold">âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„è¯¦ç»†ç»“æœã€‚</div>';
                        }
                    } else {
                        addTestResult('âŒ éªŒè¯ä¿®æ”¹ç»“æœå¤±è´¥', 'text-red-600');
                    }
                } else {
                    addTestResult('âŒ ä¿®æ”¹å¤±è´¥: ' + updateResponse.data.error.message, 'text-red-600');
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="text-red-600">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                addTestResult('âŒ æµ‹è¯•å¼‚å¸¸: ' + error.message, 'text-red-600');
            }
        });

        function addTestResult(message, className) {
            const testResultsDiv = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            testResultsDiv.appendChild(div);
        }
    </script>
</body>
</html>
