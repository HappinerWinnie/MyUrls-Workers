<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实用浏览器检测测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/browser-fingerprint.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">实用浏览器检测测试</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">基础信息</h2>
                <div id="basic-info" class="space-y-2">
                    <!-- 动态生成基础信息 -->
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">现代浏览器特征检测</h2>
                <div id="modern-features" class="space-y-2">
                    <!-- 动态生成现代浏览器特征 -->
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">Canvas指纹</h2>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="font-medium">Canvas指纹:</span>
                        <span id="canvas-fingerprint" class="text-sm text-gray-600 break-all max-w-md"></span>
                    </div>
                    <div class="mt-4">
                        <canvas id="canvas-demo" width="200" height="50" class="border border-gray-300"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">WebGL信息</h2>
                <div id="webgl-info" class="space-y-2">
                    <!-- 动态生成WebGL信息 -->
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">浏览器能力检测</h2>
                <div id="browser-features" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- 动态生成浏览器特征 -->
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">风险评分</h2>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <span class="font-medium">综合风险评分:</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-4">
                            <div id="risk-score-bar" class="bg-red-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <span id="risk-score-text" class="font-bold text-lg">0/100</span>
                    </div>
                    <div id="risk-factors" class="space-y-2">
                        <!-- 动态生成风险因素 -->
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">实际请求头测试</h2>
                <div class="space-y-4">
                    <button id="test-request" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        发送测试请求
                    </button>
                    <div id="request-headers" class="mt-4 space-y-2">
                        <!-- 显示实际发送的请求头 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 等待页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化浏览器指纹
            if (window.browserFingerprint) {
                const fingerprint = window.browserFingerprint.getFingerprint();
                displayBasicInfo(fingerprint);
                displayModernFeatures(fingerprint);
                displayCanvasFingerprint(fingerprint.canvasFingerprint);
                displayWebGLInfo(fingerprint.webglFingerprint);
                displayBrowserFeatures(fingerprint.features);
                calculateRiskScore(fingerprint);
            }

            // 绑定测试按钮事件
            document.getElementById('test-request').addEventListener('click', testRequest);
        });

        function displayBasicInfo(fingerprint) {
            const container = document.getElementById('basic-info');
            container.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">User-Agent:</span>
                    <span class="text-sm text-gray-600 break-all max-w-md">${fingerprint.userAgent || 'Unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">平台:</span>
                    <span class="text-sm text-gray-600">${fingerprint.platform || 'Unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">语言:</span>
                    <span class="text-sm text-gray-600">${fingerprint.language || 'Unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">屏幕分辨率:</span>
                    <span class="text-sm text-gray-600">${fingerprint.screen?.width || 'Unknown'}x${fingerprint.screen?.height || 'Unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">设备像素比:</span>
                    <span class="text-sm text-gray-600">${fingerprint.screen?.devicePixelRatio || 'Unknown'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">时区:</span>
                    <span class="text-sm text-gray-600">${fingerprint.timezone || 'Unknown'}</span>
                </div>
            `;
        }

        function displayModernFeatures(fingerprint) {
            const container = document.getElementById('modern-features');
            
            // 检查现代浏览器特征
            const hasSecFetch = !!(
                document.querySelector('meta[name="sec-fetch-site"]') ||
                document.querySelector('meta[name="sec-fetch-mode"]')
            );
            
            const hasSecChUa = !!(
                document.querySelector('meta[name="sec-ch-ua"]') ||
                document.querySelector('meta[name="sec-ch-ua-mobile"]')
            );
            
            const hasUpgradeInsecureRequests = document.querySelector('meta[http-equiv="upgrade-insecure-requests"]') !== null;
            const hasDNT = navigator.doNotTrack === '1';
            const hasSaveData = navigator.connection && navigator.connection.saveData;
            
            container.innerHTML = `
                <div class="flex justify-between">
                    <span class="font-medium">Sec-Fetch-* 头:</span>
                    <span class="text-sm ${hasSecFetch ? 'text-green-600' : 'text-red-600'}">
                        ${hasSecFetch ? '✓ 支持' : '✗ 不支持'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Sec-Ch-Ua-* 头:</span>
                    <span class="text-sm ${hasSecChUa ? 'text-green-600' : 'text-red-600'}">
                        ${hasSecChUa ? '✓ 支持' : '✗ 不支持'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Upgrade-Insecure-Requests:</span>
                    <span class="text-sm ${hasUpgradeInsecureRequests ? 'text-green-600' : 'text-red-600'}">
                        ${hasUpgradeInsecureRequests ? '✓ 支持' : '✗ 不支持'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">DNT (Do Not Track):</span>
                    <span class="text-sm ${hasDNT ? 'text-green-600' : 'text-red-600'}">
                        ${hasDNT ? '✓ 启用' : '✗ 未启用'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Save-Data:</span>
                    <span class="text-sm ${hasSaveData ? 'text-green-600' : 'text-red-600'}">
                        ${hasSaveData ? '✓ 启用' : '✗ 未启用'}
                    </span>
                </div>
            `;
        }

        function displayCanvasFingerprint(canvasFingerprint) {
            const container = document.getElementById('canvas-fingerprint');
            if (canvasFingerprint) {
                container.textContent = canvasFingerprint.substring(0, 100) + '...';
                
                // 显示Canvas演示
                const canvas = document.getElementById('canvas-demo');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = canvasFingerprint;
            } else {
                container.textContent = '未检测到Canvas指纹';
            }
        }

        function displayWebGLInfo(webglFingerprint) {
            const container = document.getElementById('webgl-info');
            if (webglFingerprint) {
                try {
                    const webglInfo = JSON.parse(webglFingerprint);
                    container.innerHTML = `
                        <div class="flex justify-between">
                            <span class="font-medium">供应商:</span>
                            <span class="text-sm text-gray-600">${webglInfo.vendor || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">渲染器:</span>
                            <span class="text-sm text-gray-600">${webglInfo.renderer || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">版本:</span>
                            <span class="text-sm text-gray-600">${webglInfo.version || 'Unknown'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">扩展数量:</span>
                            <span class="text-sm text-gray-600">${webglInfo.extensions?.length || 0}</span>
                        </div>
                    `;
                } catch (e) {
                    container.textContent = 'WebGL指纹解析失败';
                }
            } else {
                container.textContent = '未检测到WebGL指纹';
            }
        }

        function displayBrowserFeatures(features) {
            const container = document.getElementById('browser-features');
            const featureNames = {
                localStorage: 'Local Storage',
                sessionStorage: 'Session Storage',
                indexedDB: 'IndexedDB',
                webGL: 'WebGL',
                webGL2: 'WebGL2',
                webRTC: 'WebRTC',
                webAudio: 'Web Audio',
                geolocation: 'Geolocation',
                notification: 'Notifications',
                serviceWorker: 'Service Worker',
                audio: 'Audio',
                video: 'Video',
                canvas: 'Canvas',
                svg: 'SVG',
                webp: 'WebP',
                touch: 'Touch',
                pointer: 'Pointer',
                hover: 'Hover',
                flexbox: 'Flexbox',
                grid: 'CSS Grid'
            };

            container.innerHTML = '';
            Object.entries(features).forEach(([key, value]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <span class="text-sm font-medium">${featureNames[key] || key}:</span>
                    <span class="text-sm ${value ? 'text-green-600' : 'text-red-600'}">
                        ${value ? '✓' : '✗'}
                    </span>
                `;
                container.appendChild(div);
            });
        }

        function calculateRiskScore(fingerprint) {
            let score = 0;
            const factors = [];

            // 基础风险评分
            score += 10;
            factors.push({ factor: '基础风险', score: 10, color: 'red' });

            // 浏览器特征风险
            if (fingerprint.userAgent && fingerprint.userAgent.length > 10) {
                const ua = fingerprint.userAgent.toLowerCase();
                if (ua.includes('chrome') || ua.includes('firefox') || ua.includes('safari')) {
                    score += 20;
                    factors.push({ factor: '浏览器访问', score: 20, color: 'red' });
                }
            }

            // 移动设备风险较低
            if (fingerprint.platform === 'Android' || fingerprint.platform === 'iOS') {
                score -= 5;
                factors.push({ factor: '移动设备', score: -5, color: 'green' });
            }

            // 代理工具风险较低
            const ua = (fingerprint.userAgent || '').toLowerCase();
            if (ua.includes('clash') || ua.includes('v2ray') || ua.includes('quantumult')) {
                score -= 10;
                factors.push({ factor: '代理工具', score: -10, color: 'green' });
            }

            // 浏览器特征加分
            if (fingerprint.features) {
                const featureCount = Object.values(fingerprint.features).filter(v => v).length;
                if (featureCount > 10) {
                    score -= 5;
                    factors.push({ factor: '丰富的浏览器特征', score: -5, color: 'green' });
                }
            }

            // Canvas/WebGL指纹加分
            if (fingerprint.canvasFingerprint || fingerprint.webglFingerprint) {
                score -= 5;
                factors.push({ factor: '浏览器指纹', score: -5, color: 'green' });
            }

            score = Math.max(0, Math.min(100, score));

            // 更新UI
            document.getElementById('risk-score-text').textContent = `${score}/100`;
            document.getElementById('risk-score-bar').style.width = `${score}%`;
            document.getElementById('risk-score-bar').className = 
                `h-4 rounded-full transition-all duration-500 ${score > 70 ? 'bg-red-500' : score > 40 ? 'bg-yellow-500' : 'bg-green-500'}`;

            // 显示风险因素
            const factorsContainer = document.getElementById('risk-factors');
            factorsContainer.innerHTML = '';
            factors.forEach(factor => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `
                    <span class="text-sm">${factor.factor}</span>
                    <span class="text-sm font-medium ${factor.color === 'red' ? 'text-red-600' : factor.color === 'green' ? 'text-green-600' : 'text-yellow-600'}">
                        ${factor.score > 0 ? '+' : ''}${factor.score}
                    </span>
                `;
                factorsContainer.appendChild(div);
            });
        }

        function testRequest() {
            const container = document.getElementById('request-headers');
            container.innerHTML = '<div class="text-sm text-gray-600">正在发送测试请求...</div>';
            
            // 模拟发送请求头
            const headers = {
                'User-Agent': navigator.userAgent,
                'Accept-Language': navigator.language,
                'Accept-Encoding': 'gzip, deflate, br',
                'Sec-Fetch-Site': 'same-origin',
                'Sec-Fetch-Mode': 'navigate',
                'Sec-Fetch-Dest': 'document',
                'Sec-Fetch-User': '?1',
                'Sec-Ch-Ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                'Sec-Ch-Ua-Mobile': '?0',
                'Sec-Ch-Ua-Platform': '"Windows"',
                'Upgrade-Insecure-Requests': '1',
                'DNT': navigator.doNotTrack || '0',
                'X-Screen-Resolution': `${screen.width}x${screen.height}`,
                'X-Viewport-Width': window.innerWidth,
                'X-Viewport-Height': window.innerHeight,
                'X-Device-Pixel-Ratio': window.devicePixelRatio || 1,
                'X-Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            
            let html = '<div class="space-y-2">';
            Object.entries(headers).forEach(([key, value]) => {
                html += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium text-sm">${key}:</span>
                        <span class="text-sm text-gray-600 break-all max-w-md">${value}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
