# MyUrls 安全重定向功能实现

## 问题背景

原有的短链接服务使用标准HTTP重定向（301/302状态码），会在响应头的`Location`字段中暴露目标URL：

```http
HTTP/1.1 302 Found
Location: https://target-website.com/secret-page
```

这使得目标URL可以通过抓包工具轻易获取，存在安全隐患。

## 解决方案

实现了**安全重定向模式**，使用JavaScript重定向页面替代HTTP重定向，有效隐藏目标URL。

### 核心特性

1. **默认安全模式**：新创建的短链接默认启用安全重定向
2. **Base64编码**：目标URL在HTML中经过Base64编码，避免明文暴露
3. **向后兼容**：支持传统HTTP重定向模式
4. **用户可选**：前端界面提供安全模式开关

## 技术实现

### 1. 前端界面更新

在高级选项中添加了安全模式选择：

```html
<div>
  <label>安全模式</label>
  <div class="flex items-center space-x-4">
    <label>
      <input v-model="secureMode" type="radio" :value="true">
      安全跳转
    </label>
    <label>
      <input v-model="secureMode" type="radio" :value="false">
      直接跳转
    </label>
  </div>
  <p>安全跳转可防止目标URL被抓包工具获取</p>
</div>
```

### 2. 后端API更新

在链接数据结构中添加了`secureMode`字段：

```javascript
const linkData = {
  // ... 其他字段
  secureMode: data.secureMode !== false, // 默认启用安全模式
  // ...
};
```

### 3. 安全重定向页面

创建了美观的JavaScript重定向页面：

```javascript
function getSecureRedirectPage(targetUrl, title = '') {
  // 对URL进行Base64编码以避免在HTML源码中直接暴露
  const encodedUrl = btoa(encodeURIComponent(targetUrl));
  
  return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>${title ? title + ' - ' : ''}正在跳转 - MyUrls</title>
    <!-- 样式和动画 -->
</head>
<body>
    <div class="loading-container">
        <div class="spinner"></div>
        <h2>正在跳转...</h2>
        <p>请稍候，即将为您跳转到目标页面</p>
        <button id="manualRedirect">手动跳转</button>
    </div>

    <script>
        // 解码目标URL
        const encodedUrl = '${encodedUrl}';
        const targetUrl = decodeURIComponent(atob(encodedUrl));
        
        // 自动跳转（延迟1秒）
        setTimeout(() => {
            window.location.href = targetUrl;
        }, 1000);
        
        // 手动跳转按钮
        document.getElementById('manualRedirect').addEventListener('click', () => {
            window.location.href = targetUrl;
        });
    </script>
</body>
</html>`;
}
```

### 4. 重定向逻辑

更新了短链接访问处理逻辑：

```javascript
async function handleRedirectMode(request, linkData, kv, analytics) {
  await updateVisitStats(linkData, kv, request, analytics);

  const url = new URL(request.url);
  const forceSecure = url.searchParams.get('secure');
  
  // 优先级：URL参数 > 链接设置 > 默认启用安全模式
  let secureMode = linkData.secureMode !== false;
  if (forceSecure === 'true') {
    secureMode = true;
  } else if (forceSecure === 'false') {
    secureMode = false;
  }
  
  if (secureMode) {
    // 使用安全的JavaScript重定向页面
    return htmlResponse(getSecureRedirectPage(linkData.longUrl, linkData.title));
  } else {
    // 传统HTTP重定向（向后兼容）
    return redirectResponse(linkData.longUrl);
  }
}
```

## 安全特性

### 1. URL隐藏机制

- **Base64编码**：目标URL在HTML中经过Base64编码
- **JavaScript解码**：只在客户端JavaScript中解码
- **无HTTP头暴露**：不在HTTP响应头中包含目标URL

### 2. 抓包分析对比

**传统HTTP重定向**：
```http
GET /shortlink HTTP/1.1
Host: example.com

HTTP/1.1 302 Found
Location: https://secret-website.com/confidential-page  ← 目标URL暴露
```

**安全JavaScript重定向**：
```http
GET /shortlink HTTP/1.1
Host: example.com

HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
<script>
const encodedUrl = 'aHR0cHM6Ly9zZWNyZXQtd2Vic2l0ZS5jb20vY29uZmlkZW50aWFsLXBhZ2U%3D';
// 目标URL被Base64编码隐藏
</script>
</html>
```

### 3. 防护级别

- **基础防护**：防止简单的抓包工具直接获取目标URL
- **源码混淆**：Base64编码增加分析难度
- **用户体验**：保持良好的跳转体验

## 使用方法

### 1. 创建安全短链接

1. 在主页面点击"显示高级选项"
2. 在"安全模式"中选择"安全跳转"（默认选项）
3. 填写其他信息后点击"生成短链接"

### 2. 强制使用特定模式

通过URL参数控制重定向模式：

- `https://short.ly/abc123` - 使用链接默认设置
- `https://short.ly/abc123?secure=true` - 强制使用安全重定向
- `https://short.ly/abc123?secure=false` - 强制使用直接重定向

## 兼容性说明

- **向后兼容**：现有短链接继续正常工作
- **渐进增强**：新功能不影响旧链接
- **用户选择**：用户可以选择使用传统模式

## 注意事项

1. **JavaScript依赖**：安全重定向需要客户端启用JavaScript
2. **延迟跳转**：为显示加载动画，有1秒延迟
3. **手动备选**：提供手动跳转按钮作为备选方案
4. **SEO影响**：搜索引擎可能无法正确跟踪JavaScript重定向

## 总结

安全重定向功能有效提升了短链接服务的安全性，通过JavaScript重定向和Base64编码隐藏目标URL，防止简单的抓包分析。同时保持了良好的用户体验和向后兼容性。
