# MyUrls 自定义响应头功能

## 功能概述

为MyUrls短链接服务新增了自定义响应头功能，特别针对Clash订阅链接的需求，支持设置subscription-userinfo和content-disposition等重要响应头。

## 新增功能

### 1. Subscription-Userinfo 订阅用户信息

**用途**：用于Clash订阅链接显示流量使用情况

**格式**：`upload=字节数; download=字节数; total=字节数; expire=时间戳`

**前端界面**：
- 上传流量 (GB)：用户友好的GB单位输入
- 下载流量 (GB)：用户友好的GB单位输入  
- 总流量 (GB)：用户友好的GB单位输入
- 到期时间：日期选择器

**示例**：
```
输入：上传=0.03GB, 下载=7.97GB, 总流量=400GB, 到期=2025-12-31
输出：upload=32212254; download=8558028237; total=429496729600; expire=1775318400
```

### 2. Content-Disposition 文件下载设置

**用途**：控制文件下载行为和文件名

**格式**：`类型; filename*=UTF-8''编码后的文件名`

**前端界面**：
- 处理方式：下拉选择（不设置/下载文件/内联显示）
- 文件名：文本输入框

**示例**：
```
输入：处理方式=下载文件, 文件名=魔戒.net
输出：attachment; filename*=UTF-8''%E9%AD%94%E6%88%92.net
```

## 界面设计

### 高级选项新增区域

在现有高级选项中新增"自定义响应头（可选）"区域：

```html
<!-- 自定义响应头设置 -->
<div class="space-y-4">
  <h4 class="text-white font-medium text-left">自定义响应头（可选）</h4>
  
  <!-- Subscription-Userinfo 设置 -->
  <div>
    <label>订阅用户信息 (subscription-userinfo)</label>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div>
        <label>上传 (GB)</label>
        <input v-model="subscriptionInfo.upload" type="number" step="0.01">
      </div>
      <div>
        <label>下载 (GB)</label>
        <input v-model="subscriptionInfo.download" type="number" step="0.01">
      </div>
      <div>
        <label>总流量 (GB)</label>
        <input v-model="subscriptionInfo.total" type="number" step="0.01">
      </div>
      <div>
        <label>到期时间</label>
        <input v-model="subscriptionInfo.expire" type="date">
      </div>
    </div>
  </div>

  <!-- Content-Disposition 设置 -->
  <div>
    <label>文件下载设置 (content-disposition)</label>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <label>处理方式</label>
        <select v-model="contentDisposition.type">
          <option value="">不设置</option>
          <option value="attachment">下载文件 (attachment)</option>
          <option value="inline">内联显示 (inline)</option>
        </select>
      </div>
      <div>
        <label>文件名</label>
        <input v-model="contentDisposition.filename" :disabled="!contentDisposition.type">
      </div>
    </div>
  </div>
</div>
```

## 技术实现

### 前端处理

**数据结构**：
```javascript
data() {
  return {
    // ...
    subscriptionInfo: {
      upload: '',
      download: '',
      total: '',
      expire: ''
    },
    contentDisposition: {
      type: '',
      filename: ''
    }
  }
}
```

**响应头构建方法**：
```javascript
// 构建subscription-userinfo响应头
buildSubscriptionUserinfo() {
  const info = this.subscriptionInfo;
  if (!info.upload && !info.download && !info.total && !info.expire) {
    return null;
  }
  
  const parts = [];
  
  // 转换GB到字节
  if (info.upload) {
    const uploadBytes = Math.round(parseFloat(info.upload) * 1024 * 1024 * 1024);
    parts.push(`upload=${uploadBytes}`);
  } else {
    parts.push('upload=0');
  }
  
  if (info.download) {
    const downloadBytes = Math.round(parseFloat(info.download) * 1024 * 1024 * 1024);
    parts.push(`download=${downloadBytes}`);
  } else {
    parts.push('download=0');
  }
  
  if (info.total) {
    const totalBytes = Math.round(parseFloat(info.total) * 1024 * 1024 * 1024);
    parts.push(`total=${totalBytes}`);
  }
  
  if (info.expire) {
    const expireTimestamp = Math.floor(new Date(info.expire).getTime() / 1000);
    parts.push(`expire=${expireTimestamp}`);
  }
  
  return parts.join('; ');
}

// 构建content-disposition响应头
buildContentDisposition() {
  const disp = this.contentDisposition;
  if (!disp.type || !disp.filename) {
    return null;
  }
  
  // URL编码文件名
  const encodedFilename = encodeURIComponent(disp.filename);
  return `${disp.type}; filename*=UTF-8''${encodedFilename}`;
}
```

### 后端处理

**数据存储**：
```javascript
const linkData = {
  // ... 其他字段
  customHeaders: data.customHeaders || {}, // 自定义响应头
  // ...
};
```

**响应头应用**：
```javascript
// 重定向模式
const redirectHeaders = { 'Location': linkData.longUrl };

// 首先添加自定义响应头（优先级最高）
if (linkData.customHeaders) {
  for (const [headerName, headerValue] of Object.entries(linkData.customHeaders)) {
    if (headerValue) {
      redirectHeaders[headerName] = headerValue;
    }
  }
}

// 然后保留从目标URL获取的重要响应头（如果自定义响应头中没有设置）
for (const headerName of preserveHeaders) {
  if (!redirectHeaders[headerName]) {
    const headerValue = headResponse.headers.get(headerName);
    if (headerValue) {
      redirectHeaders[headerName] = headerValue;
    }
  }
}
```

## 优先级规则

1. **自定义响应头**：最高优先级，用户设置的响应头
2. **目标URL响应头**：次优先级，从原始链接获取的响应头
3. **系统默认响应头**：最低优先级，系统添加的安全响应头

## 使用场景

### Clash订阅链接

**场景**：为Clash订阅链接设置流量信息
```
上传：0.03 GB
下载：7.97 GB  
总流量：400 GB
到期：2025-12-31
```

**生成的响应头**：
```
subscription-userinfo: upload=32212254; download=8558028237; total=429496729600; expire=1775318400
```

### 文件下载链接

**场景**：设置配置文件下载
```
处理方式：下载文件
文件名：clash-config.yaml
```

**生成的响应头**：
```
content-disposition: attachment; filename*=UTF-8''clash-config.yaml
```

## 兼容性说明

1. **向后兼容**：现有短链接继续正常工作
2. **可选功能**：不设置自定义响应头时不影响现有功能
3. **优雅降级**：自定义响应头设置失败时仍能正常重定向

## 测试方法

### 创建带自定义响应头的短链接

1. 打开MyUrls主页
2. 点击"显示高级选项"
3. 在"自定义响应头"区域设置：
   - 订阅用户信息：设置流量和到期时间
   - 文件下载设置：选择处理方式和文件名
4. 创建短链接

### 验证响应头

```bash
# 检查重定向响应头
curl -I http://short.ly/abc123

# 应该看到自定义响应头，如：
# HTTP/1.1 302 Found
# Location: https://target-url.com
# subscription-userinfo: upload=0; download=8558028237; total=429496729600; expire=1775318400
# content-disposition: attachment; filename*=UTF-8''config.yaml
```

## 总结

自定义响应头功能为MyUrls增加了强大的灵活性：

- **用户友好**：提供直观的界面设置复杂的响应头
- **专业支持**：特别优化Clash订阅链接的需求
- **优先级控制**：合理的响应头优先级规则
- **完全兼容**：不影响现有功能和使用方式

特别适用于需要精确控制HTTP响应头的专业场景。
