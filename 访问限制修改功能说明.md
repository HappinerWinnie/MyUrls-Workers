# MyUrls 访问限制修改功能

## 功能概述

为MyUrls管理后台新增了链接编辑功能，支持在后台修改访问限制次数，包括增加、减少访问次数或重置访问计数。

## 新增功能

### 1. 链接编辑界面

**位置**：管理后台 → 链接管理 → 编辑按钮

**功能**：
- 修改链接标题和描述
- **调整访问次数限制**（核心功能）
- **重置当前访问次数**
- 启用/禁用链接状态

### 2. 访问限制修改逻辑

**智能提示系统**：
- **增加限制**：显示将增加的访问机会数量
- **减少限制**：显示将减少的访问机会数量
- **危险操作警告**：当新限制小于当前访问次数时警告链接将失效

**示例场景**：
```
原始状态：5/5 (已用完)
修改为：10 → 显示"将增加 5 次访问机会"
修改为：3 → 显示"⚠️ 新限制小于当前访问次数，链接将立即失效"
```

### 3. 访问计数重置

**功能**：可以将当前访问次数重置为任意值
**用途**：
- 重置访问计数到0，恢复链接可用性
- 调整访问计数以匹配实际使用情况
- 批量重置多个链接的访问状态

## 界面设计

### 编辑模态框

```html
<!-- 访问限制设置区域 -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
        <label>访问次数限制</label>
        <input type="number" v-model="editingLink.maxVisits" min="-1">
        <p class="text-xs text-gray-500">-1表示无限制</p>
        
        <!-- 智能提示 -->
        <div v-if="editingLink.maxVisits !== originalMaxVisits" class="mt-2 p-2 bg-blue-50 rounded-md">
            <p class="text-sm text-blue-700">
                <span v-if="editingLink.maxVisits > originalMaxVisits">
                    将增加 {{ editingLink.maxVisits - originalMaxVisits }} 次访问机会
                </span>
                <span v-else-if="editingLink.maxVisits < originalMaxVisits && editingLink.maxVisits >= editingLink.currentVisits">
                    将减少 {{ originalMaxVisits - editingLink.maxVisits }} 次访问机会
                </span>
                <span v-else-if="editingLink.maxVisits < editingLink.currentVisits && editingLink.maxVisits > 0">
                    ⚠️ 新限制小于当前访问次数，链接将立即失效
                </span>
            </p>
        </div>
    </div>
    
    <div>
        <label>当前访问次数</label>
        <input type="number" v-model="editingLink.currentVisits" min="0">
        <p class="text-xs text-gray-500">可以重置访问计数</p>
    </div>
</div>
```

## 技术实现

### 前端实现

**Vue.js数据结构**：
```javascript
data() {
    return {
        showEditModal: false,
        editingLink: {},
        originalMaxVisits: 0, // 用于计算变化量
        updating: false
    }
}
```

**编辑方法**：
```javascript
editLink(link) {
    this.editingLink = {
        id: link.id,
        shortKey: link.shortKey,
        longUrl: link.longUrl,
        title: link.title || '',
        description: link.description || '',
        maxVisits: link.maxVisits,
        currentVisits: link.currentVisits,
        isActive: link.isActive
    };
    this.originalMaxVisits = link.maxVisits; // 保存原始值用于比较
    this.showEditModal = true;
}
```

**更新方法**：
```javascript
async updateLink() {
    const updateData = {
        title: this.editingLink.title,
        description: this.editingLink.description,
        maxVisits: parseInt(this.editingLink.maxVisits),
        currentVisits: parseInt(this.editingLink.currentVisits),
        isActive: this.editingLink.isActive
    };

    const response = await axios.put('/api/links/' + this.editingLink.shortKey, updateData);
    // 处理响应...
}
```

### 后端实现

**API端点**：`PUT /api/links/{shortKey}`

**Cloudflare Workers版本**：
```javascript
if (updateData.maxVisits !== undefined) {
    const maxVisits = parseInt(updateData.maxVisits);
    linkData.maxVisits = isNaN(maxVisits) ? -1 : maxVisits;
}

if (updateData.currentVisits !== undefined) {
    const currentVisits = parseInt(updateData.currentVisits);
    linkData.currentVisits = isNaN(currentVisits) ? 0 : Math.max(0, currentVisits);
}
```

**简化开发服务器版本**：
```javascript
if (updateData.maxVisits !== undefined) {
    linkData.maxVisits = parseInt(updateData.maxVisits) || -1;
}
if (updateData.currentVisits !== undefined) {
    linkData.currentVisits = Math.max(0, parseInt(updateData.currentVisits) || 0);
}
```

## 使用场景

### 场景1：增加访问次数

**情况**：链接访问次数用完，需要增加访问机会
```
原始：5/5 (已用完)
操作：将maxVisits改为10
结果：5/10 (恢复可用，新增5次机会)
```

### 场景2：减少访问次数

**情况**：需要限制链接的剩余访问次数
```
原始：2/10 (还有8次机会)
操作：将maxVisits改为5
结果：2/5 (还有3次机会)
```

### 场景3：重置访问计数

**情况**：重置链接使用状态
```
原始：5/5 (已用完)
操作：将currentVisits改为0
结果：0/5 (完全重置，恢复5次机会)
```

### 场景4：危险操作

**情况**：新限制小于当前访问次数
```
原始：8/10 (已访问8次)
操作：将maxVisits改为5
结果：8/5 (立即失效，因为8 > 5)
警告：⚠️ 新限制小于当前访问次数，链接将立即失效
```

## 安全考虑

1. **权限控制**：只有管理员可以修改访问限制
2. **数据验证**：确保输入的数值合法
3. **操作提示**：危险操作时显示明确警告
4. **原子操作**：更新操作要么全部成功，要么全部失败

## 兼容性

1. **向后兼容**：现有链接不受影响
2. **API兼容**：新增字段不影响现有API调用
3. **数据兼容**：新字段有默认值，不会破坏现有数据

## 测试方法

### 1. 创建测试链接
```bash
# 创建一个访问限制为5次的链接
POST /api/links
{
    "longUrl": "https://example.com",
    "maxVisits": 5
}
```

### 2. 访问链接直到用完
```bash
# 访问5次直到用完
GET /shortkey (重复5次)
```

### 3. 增加访问次数
```bash
# 将访问限制改为10次
PUT /api/links/shortkey
{
    "maxVisits": 10
}
```

### 4. 验证结果
```bash
# 检查链接状态，应该显示 5/10
GET /api/links/shortkey
```

## 总结

访问限制修改功能为MyUrls管理后台提供了强大的链接管理能力：

- **灵活调整**：可以随时增加或减少访问次数
- **智能提示**：清晰显示操作的影响
- **安全操作**：危险操作有明确警告
- **完整功能**：支持访问计数重置和链接状态管理

特别适用于需要动态调整链接访问策略的场景，如活动推广、资源分发等。
